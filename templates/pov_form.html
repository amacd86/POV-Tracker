{% extends "layout.html" %}

{% block title %}{{ title }}{% endblock %}

{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3>{{ title or 'POV Form' }}</h3>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <!-- Basic Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="deal_name" class="form-label">Deal Name *</label>
                                    <input type="text" class="form-control" id="deal_name" name="deal_name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="customer_name" class="form-label">Customer Contact Name *</label>
                                    <input type="text" class="form-control" id="customer_name" name="customer_name" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="customer_email" class="form-label">Customer Email</label>
                                    <input type="email" class="form-control" id="customer_email" name="customer_email">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="deal_amount" class="form-label">Deal Amount ($)</label>
                                    <input type="number" class="form-control" id="deal_amount" name="deal_amount" step="0.01">
                                </div>
                            </div>
                        </div>

                        <!-- Team Assignment -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="assigned_ae" class="form-label">Account Executive *</label>
                                    <input type="text" class="form-control" id="assigned_ae" name="assigned_ae" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="assigned_se" class="form-label">Sales Engineer</label>
                                    <input type="text" class="form-control" id="assigned_se" name="assigned_se">
                                </div>
                            </div>
                        </div>

                        <!-- POV Details -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="current_stage" class="form-label">Current Stage *</label>
                                    <select class="form-control" id="current_stage" name="current_stage" required>
                                        <option value="">Select Stage</option>
                                        <option value="Initial Contact">Initial Contact</option>
                                        <option value="Discovery">Discovery</option>
                                        <option value="Deployment">Deployment</option>
                                        <option value="Training 1">Training 1</option>
                                        <option value="Training 2">Training 2</option>
                                        <option value="POV Wrap-Up">POV Wrap-Up</option>
                                        <option value="Evaluation">Evaluation</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="status" class="form-label">Status *</label>
                                    <select class="form-control" id="status" name="status" required>
                                        <option value="">Select Status</option>
                                        <option value="Active">Active</option>
                                        <option value="On Hold">On Hold</option>
                                        <option value="Closed Won">Closed Won</option>
                                        <option value="Closed Lost">Closed Lost</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mt-4">
                                    <input type="checkbox" class="form-check-input" id="technical_win" name="technical_win" value="1">
                                    <label class="form-check-label" for="technical_win">
                                        Technical Win
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Dates -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="start_date" class="form-label">Start Date *</label>
                                    <input type="date" class="form-control" id="start_date" name="start_date" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="projected_end_date" class="form-label">Projected End Date</label>
                                    <input type="date" class="form-control" id="projected_end_date" name="projected_end_date">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="actual_completion_date" class="form-label">Actual Completion Date</label>
                                    <input type="date" class="form-control" id="actual_completion_date" name="actual_completion_date">
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Roadblock Section -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5>üöß Roadblock Information (Optional)</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="roadblock_category" class="form-label">Category</label>
                                            <select class="form-control" id="roadblock_category" name="roadblock_category">
                                                <option value="">No Roadblock</option>
                                                <option value="Technical">üîß Technical</option>
                                                <option value="Budget">üí∞ Budget</option>
                                                <option value="Timeline">‚è∞ Timeline</option>
                                                <option value="Decision Maker">üë• Decision Maker</option>
                                                <option value="Competitive">‚öîÔ∏è Competitive</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="roadblock_severity" class="form-label">Severity</label>
                                            <select class="form-control" id="roadblock_severity" name="roadblock_severity">
                                                <option value="">Select Severity</option>
                                                <option value="Low">üü¢ Low</option>
                                                <option value="Medium">üü° Medium</option>
                                                <option value="High">üî¥ High</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="roadblock_owner" class="form-label">Owner</label>
                                            <select class="form-control" id="roadblock_owner" name="roadblock_owner">
                                                <option value="">Select Owner</option>
                                                <option value="AE">üëî AE</option>
                                                <option value="SE">üõ†Ô∏è SE</option>
                                                <option value="Leadership">üëë Leadership</option>
                                                <option value="Engineering">‚öôÔ∏è Engineering</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="roadblock_notes" class="form-label">Roadblock Notes</label>
                                    <textarea class="form-control" id="roadblock_notes" name="roadblock_notes" rows="3" placeholder="Describe the roadblock and action steps..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="success_criteria" class="form-label">Success Criteria</label>
                                    <textarea class="form-control" id="success_criteria" name="success_criteria" rows="3" placeholder="What defines success for this POV?"></textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="notes" class="form-label">General Notes</label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Additional notes..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Legacy Roadblock Fields (for compatibility) -->
                        <div class="form-group mb-3">
                            <label for="roadblocks" class="form-label">Legacy Roadblocks</label>
                            <textarea class="form-control" id="roadblocks" name="roadblocks" rows="2" placeholder="Any existing roadblock notes..."></textarea>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="form-group mt-4">
                            <button type="submit" class="btn btn-primary">Save POV</button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary ml-2">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-enable roadblock fields when category is selected
document.getElementById('roadblock_category').addEventListener('change', function() {
    const severity = document.getElementById('roadblock_severity');
    const owner = document.getElementById('roadblock_owner');
    
    if (this.value) {
        severity.required = true;
        owner.required = true;
    } else {
        severity.required = false;
        owner.required = false;
        severity.value = '';
        owner.value = '';
    }
});
</script>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-calculate projected end date based on start date (optional feature)
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('projected_end_date');
        
        startDateInput.addEventListener('change', function() {
            if (this.value && !endDateInput.value) {
                const startDate = new Date(this.value);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 30); // Default 30 days
                
                const year = endDate.getFullYear();
                const month = String(endDate.getMonth() + 1).padStart(2, '0');
                const day = String(endDate.getDate()).padStart(2, '0');
                
                endDateInput.value = `${year}-${month}-${day}`;
            }
        });

        // Format price input
        const priceInput = document.getElementById('price');
        priceInput.addEventListener('blur', function() {
            if (this.value && !isNaN(this.value)) {
                this.value = parseFloat(this.value).toFixed(2);
            }
        });

        // Character counter for roadblocks and notes (optional)
        const roadblocksTextarea = document.querySelector('textarea[name="roadblocks"]');
        const notesTextarea = document.querySelector('textarea[name="initial_notes"]');
        
        function addCharacterCounter(textarea, maxLength = 1000) {
            if (!textarea) return;
            
            const counter = document.createElement('div');
            counter.className = 'form-text text-end';
            counter.style.fontSize = '0.875rem';
            
            function updateCounter() {
                const remaining = maxLength - textarea.value.length;
                counter.textContent = `${textarea.value.length}/${maxLength} characters`;
                counter.style.color = remaining < 50 ? '#dc3545' : '#6c757d';
            }
            
            textarea.addEventListener('input', updateCounter);
            textarea.parentNode.appendChild(counter);
            updateCounter();
        }
        
        addCharacterCounter(roadblocksTextarea, 500);
        addCharacterCounter(notesTextarea, 1000);

        // Convert all timestamps to user's local time
        const timestamps = document.querySelectorAll('.timestamp');
        timestamps.forEach(function(element) {
            const utcTime = element.getAttribute('data-utc');
            if (utcTime) {
                const localTime = new Date(utcTime + ' UTC');
                element.textContent = localTime.toLocaleString('en-US', {
                    month: '2-digit',
                    day: '2-digit',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            }
        });
    });
</script>
{% endblock %}