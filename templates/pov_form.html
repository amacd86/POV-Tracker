{% extends "layout.html" %}

{% block title %}{{ title }}{% endblock %}

{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3>{{ title or 'POV Form' }}</h3>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {{ form.hidden_tag() }}

                        <div class="row g-3">
                            <div class="col-md-6">
                                {{ form.deal_name.label(class="form-label") }}
                                {{ form.deal_name(class="form-control") }}
                            </div>

                            <div class="col-md-6">
                                {{ form.customer_name.label(class="form-label") }}
                                {{ form.customer_name(class="form-control") }}
                            </div>

                            <div class="col-md-6">
                                {{ form.assigned_ae.label(class="form-label") }}
                                {{ form.assigned_ae(class="form-control") }}
                            </div>

                            <div class="col-md-6">
                                {{ form.assigned_se.label(class="form-label") }}
                                {{ form.assigned_se(class="form-control") }}
                            </div>

                            <div class="col-md-6">
                                {{ form.current_stage.label(class="form-label") }}
                                {{ form.current_stage(class="form-select") }}
                            </div>

                            <div class="col-md-6">
                                {{ form.status.label(class="form-label") }}
                                {{ form.status(class="form-select") }}
                            </div>

                            <div class="col-md-4">
                                {{ form.start_date.label(class="form-label") }}
                                {{ form.start_date(class="form-control") }}
                            </div>

                            <div class="col-md-4">
                                {{ form.projected_end_date.label(class="form-label") }}
                                {{ form.projected_end_date(class="form-control") }}
                            </div>
                            
                            <div class="col-md-4">
                                {{ form.actual_completion_date.label(class="form-label") }}
                                {{ form.actual_completion_date(class="form-control") }}
                            </div>
                            
                            <div class="col-md-6">
                                {{ form.deal_amount.label(class="form-label") }}
                                {{ form.deal_amount(class="form-control") }}
                            </div>

                            <div class="col-md-6 d-flex align-items-end">
                                <div class="form-check mb-2">
                                    {{ form.technical_win(class="form-check-input") }}
                                    {{ form.technical_win.label(class="form-check-label") }}
                                </div>
                            </div>

                            <div class="col-12">
                                {{ form.success_criteria.label(class="form-label") }}
                                {{ form.success_criteria(class="form-control") }}
                            </div>
                            
                            <hr class="my-4">
                            
                            <h5 class="col-12">Roadblock Information</h5>
                            
                            <div class="col-md-4">
                                {{ form.roadblock_category.label(class="form-label") }}
                                {{ form.roadblock_category(class="form-select") }}
                            </div>

                            <div class="col-md-4">
                                {{ form.roadblock_severity.label(class="form-label") }}
                                {{ form.roadblock_severity(class="form-select") }}
                            </div>

                            <div class="col-md-4">
                                {{ form.roadblock_owner.label(class="form-label") }}
                                {{ form.roadblock_owner(class="form-select") }}
                            </div>

                            <div class="col-12">
                                {{ form.roadblock_notes.label(class="form-label") }}
                                {{ form.roadblock_notes(class="form-control") }}
                            </div>
                        </div>

                        <div class="mt-4">
                            {{ form.submit(class="btn btn-primary") }}
                            <a href="{{ url_for('pov_detail', pov_id=pov.id) }}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-enable roadblock fields when category is selected
document.getElementById('roadblock_category').addEventListener('change', function() {
    const severity = document.getElementById('roadblock_severity');
    const owner = document.getElementById('roadblock_owner');
    
    if (this.value) {
        severity.required = true;
        owner.required = true;
    } else {
        severity.required = false;
        owner.required = false;
        severity.value = '';
        owner.value = '';
    }
});
</script>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-calculate projected end date based on start date (optional feature)
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('projected_end_date');
        
        startDateInput.addEventListener('change', function() {
            if (this.value && !endDateInput.value) {
                const startDate = new Date(this.value);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 30); // Default 30 days
                
                const year = endDate.getFullYear();
                const month = String(endDate.getMonth() + 1).padStart(2, '0');
                const day = String(endDate.getDate()).padStart(2, '0');
                
                endDateInput.value = `${year}-${month}-${day}`;
            }
        });

        // Format price input
        const priceInput = document.getElementById('price');
        priceInput.addEventListener('blur', function() {
            if (this.value && !isNaN(this.value)) {
                this.value = parseFloat(this.value).toFixed(2);
            }
        });

        // Character counter for roadblocks and notes (optional)
        const roadblocksTextarea = document.querySelector('textarea[name="roadblocks"]');
        const notesTextarea = document.querySelector('textarea[name="initial_notes"]');
        
        function addCharacterCounter(textarea, maxLength = 1000) {
            if (!textarea) return;
            
            const counter = document.createElement('div');
            counter.className = 'form-text text-end';
            counter.style.fontSize = '0.875rem';
            
            function updateCounter() {
                const remaining = maxLength - textarea.value.length;
                counter.textContent = `${textarea.value.length}/${maxLength} characters`;
                counter.style.color = remaining < 50 ? '#dc3545' : '#6c757d';
            }
            
            textarea.addEventListener('input', updateCounter);
            textarea.parentNode.appendChild(counter);
            updateCounter();
        }
        
        addCharacterCounter(roadblocksTextarea, 500);
        addCharacterCounter(notesTextarea, 1000);

        // Convert all timestamps to user's local time
        const timestamps = document.querySelectorAll('.timestamp');
        timestamps.forEach(function(element) {
            const utcTime = element.getAttribute('data-utc');
            if (utcTime) {
                const localTime = new Date(utcTime + ' UTC');
                element.textContent = localTime.toLocaleString('en-US', {
                    month: '2-digit',
                    day: '2-digit',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            }
        });
    });
</script>
{% endblock %}