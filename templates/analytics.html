{% extends "layout.html" %}

{% block title %}POV Analytics{% endblock %}
{% block page_title %}POV Analytics{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col"><h5 class="mb-0">POV Dashboard Analytics</h5></div>
            <div class="col-auto"><a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-arrow-left me-1"></i>Back to Dashboard</a></div>
        </div>
    </div>
    <div class="card-body">
        <div class="row g-4">
            <div class="col-md-3">
                <a href="{{ url_for('details', metric='ending_soon') }}" class="text-decoration-none">
                    <div class="card h-100 shadow-sm bg-primary text-white">
                        <div class="card-body text-center">
                            <h2 class="display-5 fw-bold">{{ metrics.ending_soon }}</h2>
                            <p class="card-text">POVs ending in next 2 weeks</p>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-3">
                <a href="{{ url_for('details', metric='overdue') }}" class="text-decoration-none">
                    <div class="card h-100 shadow-sm bg-danger text-white">
                        <div class="card-body text-center">
                            <h2 class="display-5 fw-bold">{{ metrics.overdue }}</h2>
                            <p class="card-text">POVs past end date</p>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-3">
                <div class="card h-100 shadow-sm bg-info text-white">
                    <div class="card-body text-center">
                        <h2 class="display-5 fw-bold">{{ metrics.avg_duration }}</h2>
                        <p class="card-text">Days per active POV</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <a href="{{ url_for('details', metric='active') }}" class="text-decoration-none">
                    <div class="card h-100 shadow-sm bg-success text-white">
                        <div class="card-body text-center">
                            <h2 class="display-5 fw-bold metric-value">${{ '{:,.0f}'.format(metrics.total_value) }}</h2>
                            <p class="card-text">Total Value of Active POVs</p>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-3">
                <a href="{{ url_for('details', metric='technical_wins') }}" class="text-decoration-none">
                    <div class="card h-100 shadow-sm bg-dark text-white">
                        <div class="card-body text-center">
                            <h2 class="display-5 fw-bold">{{ metrics.technical_wins }}</h2>
                            <p class="card-text">Completed Technical Wins</p>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-3">
                <a href="{{ url_for('details', metric='closed_won') }}" class="text-decoration-none text-dark">
                    <div class="card h-100 shadow-sm bg-warning">
                        <div class="card-body text-center">
                            <h2 class="display-5 fw-bold">{{ metrics.pov_conversion_rate }}%</h2>
                            <p class="card-text">Conversion to Closed Won</p>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-3">
                <a href="{{ url_for('details', metric='technical_wins') }}" class="text-decoration-none text-dark">
                    <div class="card h-100 shadow-sm bg-warning">
                        <div class="card-body text-center">
                            <h2 class="display-5 fw-bold">{{ metrics.tech_win_rate }}%</h2>
                            <p class="card-text">Technical Win Rate</p>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-3">
                <a href="{{ url_for('details', metric='active') }}" class="text-decoration-none">
                    <div class="card h-100 shadow-sm bg-secondary text-white">
                        <div class="card-body text-center">
                            <h2 class="display-5 fw-bold">{{ metrics.povs_in_progress }}</h2>
                            <p class="card-text">Active POV Count</p>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-lg-6 mb-4"><div class="chart-container"><h5 class="mb-3">POVs by Status</h5><canvas id="statusChart"></canvas></div></div>
            <div class="col-lg-6 mb-4"><div class="chart-container"><h5 class="mb-3">POVs by Stage (Active)</h5><canvas id="stageChart"></canvas></div></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const chartColors = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6c757d'];

    // Status Chart
    const statusChartData = {{ status_chart_data|tojson }};
    new Chart(document.getElementById('statusChart').getContext('2d'), {
        type: 'pie',
        data: {
            labels: statusChartData.map(d => `${d.label} (${(d.value / statusChartData.reduce((a, b) => a + b.value, 0) * 100).toFixed(0)}%)`),
            datasets: [{ data: statusChartData.map(d => d.value), backgroundColor: chartColors }]
        },
        options: { responsive: true, plugins: { legend: { position: 'right' } } }
    });

    // Stage Chart
    const stageChartData = {{ stage_chart_data|tojson }};
    new Chart(document.getElementById('stageChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: stageChartData.map(d => d.label),
            datasets: [{ label: 'Active POVs', data: stageChartData.map(d => d.value), backgroundColor: chartColors }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
    });
});
</script>
<style>
    .metric-card{color:#fff;border-radius:8px;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,.1);text-align:center;}.metric-number{font-size:36px;font-weight:700}.metric-label{font-size:14px;opacity:.9}.card-ending-soon{background:linear-gradient(45deg,#007bff,#0056b3)}.card-overdue{background:linear-gradient(45deg,#dc3545,#b02a37)}.card-duration{background:linear-gradient(45deg,#17a2b8,#107585)}.card-value{background:linear-gradient(45deg,#28a745,#1e7e34)}.card-tech-wins{background:linear-gradient(45deg,#17a2b8,#107585)}.card-cw-rate{background:linear-gradient(45deg,#ffc107,#d39e00)}.card-tech-win-rate{background:linear-gradient(45deg,#6c757d,#5a6268)}.card-in-progress{background:linear-gradient(45deg,#343a40,#23272b)}.stage-card{background:#f8f9fa;color:#333;border-left:5px solid}.stage-card:nth-child(1){border-color:#17a2b8}.stage-card:nth-child(2){border-color:#007bff}.stage-card:nth-child(3){border-color:#ffc107}.stage-card:nth-child(4){border-color:#28a745}.chart-container{background:#fff;border-radius:8px;padding:25px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
</style>
{% endblock %}