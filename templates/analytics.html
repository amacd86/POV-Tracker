{% extends "layout.html" %}

{% block title %}POV Analytics{% endblock %}
{% block page_title %}POV Analytics{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col"><h5 class="mb-0">POV Dashboard Analytics</h5></div>
            <div class="col-auto"><a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-arrow-left me-1"></i>Back to Dashboard</a></div>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-lg-3 col-md-6 mb-4"><div class="metric-card card-ending-soon"><div class="metric-number">{{ metrics.ending_soon }}</div><div class="metric-label">POVs ending in next 2 weeks</div></div></div>
            <div class="col-lg-3 col-md-6 mb-4"><div class="metric-card card-overdue"><div class="metric-number">{{ metrics.overdue }}</div><div class="metric-label">POVs past end date</div></div></div>
            <div class="col-lg-3 col-md-6 mb-4"><div class="metric-card card-duration"><div class="metric-number">{{ metrics.avg_duration }}</div><div class="metric-label">Days per active POV</div></div></div>
            <div class="col-lg-3 col-md-6 mb-4"><div class="metric-card card-value"><div class="metric-number">${{ "{:,.0f}".format(metrics.total_value) }}</div><div class="metric-label">Total Value of Active POVs</div></div></div>
        </div>

        <div class="row">
            <div class="col-lg-3 col-md-6 mb-4"><div class="metric-card card-tech-wins"><div class="metric-number">{{ metrics.technical_wins }}</div><div class="metric-label">Completed Technical Wins</div></div></div>
            <div class="col-lg-3 col-md-6 mb-4"><div class="metric-card card-cw-rate"><div class="metric-number">{{ metrics.pov_conversion_rate }}%</div><div class="metric-label">Conversion to Closed Won</div></div></div>
            <div class="col-lg-3 col-md-6 mb-4"><div class="metric-card card-tech-win-rate"><div class="metric-number">{{ metrics.tech_win_rate }}%</div><div class="metric-label">Technical Win Rate</div></div></div>
            <div class="col-lg-3 col-md-6 mb-4"><div class="metric-card card-in-progress"><div class="metric-number">{{ metrics.povs_in_progress }}</div><div class="metric-label">Active POV Count</div></div></div>
        </div>
        
        <h5 class="mt-4">Current Stage Distribution (Active POVs)</h5>
        <div class="row">
             <div class="col-lg-3 col-md-6 mb-4"><div class="metric-card stage-card"><div class="metric-number">{{ metrics.stage_counts.deployment }}</div><div class="metric-label">Deployment</div></div></div>
             <div class="col-lg-3 col-md-6 mb-4"><div class="metric-card stage-card"><div class="metric-number">{{ metrics.stage_counts.training_1 }}</div><div class="metric-label">Training 1</div></div></div>
             <div class="col-lg-3 col-md-6 mb-4"><div class="metric-card stage-card"><div class="metric-number">{{ metrics.stage_counts.training_2 }}</div><div class="metric-label">Training 2</div></div></div>
             <div class="col-lg-3 col-md-6 mb-4"><div class="metric-card stage-card"><div class="metric-number">{{ metrics.stage_counts.pov_wrap_up }}</div><div class="metric-label">POV Wrap-Up</div></div></div>
        </div>

        <div class="row mt-4">
            <div class="col-lg-6 mb-4"><div class="chart-container"><h5 class="mb-3">POVs by Status</h5><canvas id="statusChart"></canvas></div></div>
            <div class="col-lg-6 mb-4"><div class="chart-container"><h5 class="mb-3">POVs by Stage (Active)</h5><canvas id="stageChart"></canvas></div></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const chartColors = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6c757d'];

    // Status Chart
    const statusChartData = {{ status_chart_data|tojson }};
    new Chart(document.getElementById('statusChart').getContext('2d'), {
        type: 'pie',
        data: {
            labels: statusChartData.map(d => `${d.label} (${(d.value / statusChartData.reduce((a, b) => a + b.value, 0) * 100).toFixed(0)}%)`),
            datasets: [{ data: statusChartData.map(d => d.value), backgroundColor: chartColors }]
        },
        options: { responsive: true, plugins: { legend: { position: 'right' } } }
    });

    // Stage Chart
    const stageChartData = {{ stage_chart_data|tojson }};
    new Chart(document.getElementById('stageChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: stageChartData.map(d => d.label),
            datasets: [{ label: 'Active POVs', data: stageChartData.map(d => d.value), backgroundColor: chartColors }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
    });
});
</script>
<style>
    .metric-card{color:#fff;border-radius:8px;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,.1);text-align:center;}.metric-number{font-size:36px;font-weight:700}.metric-label{font-size:14px;opacity:.9}.card-ending-soon{background:linear-gradient(45deg,#007bff,#0056b3)}.card-overdue{background:linear-gradient(45deg,#dc3545,#b02a37)}.card-duration{background:linear-gradient(45deg,#17a2b8,#107585)}.card-value{background:linear-gradient(45deg,#28a745,#1e7e34)}.card-tech-wins{background:linear-gradient(45deg,#17a2b8,#107585)}.card-cw-rate{background:linear-gradient(45deg,#ffc107,#d39e00)}.card-tech-win-rate{background:linear-gradient(45deg,#6c757d,#5a6268)}.card-in-progress{background:linear-gradient(45deg,#343a40,#23272b)}.stage-card{background:#f8f9fa;color:#333;border-left:5px solid}.stage-card:nth-child(1){border-color:#17a2b8}.stage-card:nth-child(2){border-color:#007bff}.stage-card:nth-child(3){border-color:#ffc107}.stage-card:nth-child(4){border-color:#28a745}.chart-container{background:#fff;border-radius:8px;padding:25px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
</style>
{% endblock %}